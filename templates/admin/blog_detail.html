{% extends "admin/base.html" %}
{% from "macros/sonic_icons.html" import sonic_icon %}

{% block title %}{{ blog.name }}{% endblock %}
{% block header %}{{ blog.name }}{% endblock %}
{% block subheader %}Contract: {{ blog.generation_contract_default or 'v1.1' }} • {{ blog.primary_objective }}{%
endblock %}

{% block content %}
<section class="page" id="page-blog-detail">
    <!-- Config Card -->
    <div class="card">
        <div class="cardHeader">
            <div>
                <h3>Configuration</h3>
                <p>Base ID: {{ blog.airtable.base_id_resolved }}</p>
            </div>
            <div class="rowActions">
                <a href="https://airtable.com/{{ blog.airtable.base_id_resolved }}" target="_blank" class="btn">Open
                    Airtable</a>
                <button class="btn primary">+ New Post</button>
            </div>
        </div>
        <div class="cardBody">
            <div class="grid cols-3">
                <div class="field">
                    <label>Primary Objective</label>
                    <div style="font-size:13px;">{{ blog.primary_objective }}</div>
                </div>
                <div class="field">
                    <label>Contract Version</label>
                    <div style="font-size:13px;">{{ blog.generation_contract_default or 'v1.1' }}</div>
                </div>
                <div class="field">
                    <label>Domain</label>
                    <div style="font-size:13px;">{{ blog.domain }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Posts Catalog (Hyper Sonic Grid) -->
    <div class="space-y-6 mt-8">
        <div class="flex items-center justify-between">
            <h4 class="text-xl font-bold text-white tracking-widest uppercase">Post Catalog</h4>
            <div class="h-[1px] flex-grow mx-6 bg-gradient-to-r from-white/10 to-transparent"></div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for post in posts %}
            {% set obj = post.fields.PrimaryObjective or "Awareness" %}
            {% set hex = "#60a5fa" %}
            {% if obj == 'Traffic' %}{% set hex = "#22d3ee" %}
            {% elif obj == 'Leads' %}{% set hex = "#818cf8" %}
            {% elif obj == 'Authority' %}{% set hex = "#d8b4fe" %}
            {% elif obj == 'Revenue' %}{% set hex = "#fbbf24" %}
            {% elif obj == 'Engagement' %}{% set hex = "#f87171" %}
            {% elif obj == 'Informational' %}{% set hex = "#38bdf8" %}
            {% elif obj == 'Transactional' %}{% set hex = "#4ade80" %}
            {% endif %}

            <div class="group relative h-72 cursor-pointer perspective-1000">
                <!-- Wrapper for Edit Action or Detail View -->
                <div class="absolute inset-0 rounded-xl overflow-hidden transition-all duration-500 border border-white/10 bg-[#0a0a0c]/50 backdrop-blur-md flex flex-col items-center justify-center group-hover:border-white/40 group-hover:bg-white/5"
                    style="box-shadow: 0 0 0 transparent;" onmouseover="this.style.boxShadow='0 0 20px {{ hex }}20'"
                    onmouseout="this.style.boxShadow='0 0 0 transparent'">

                    <!-- Glow Lines -->
                    <div
                        class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-50 transition-opacity duration-500">
                    </div>
                    <div
                        class="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-50 transition-opacity duration-500">
                    </div>

                    <!-- Icon -->
                    <div class="relative w-24 h-24 mb-4 flex items-center justify-center">
                        {{ sonic_icon(obj, hex) }}
                    </div>

                    <!-- Text -->
                    <div class="relative z-10 text-center space-y-2 px-4 w-full">
                        <h3
                            class="text-sm font-bold tracking-wider uppercase font-mono transition-colors duration-300 text-gray-400 group-hover:text-white line-clamp-2">
                            {{ post.fields.Title or 'Untitled' }}
                        </h3>

                        <!-- Status Badge -->
                        <div class="flex items-center justify-center gap-2">
                            {% if post.fields.Status == 'Published' %}
                            <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></span>
                            <span class="text-[10px] uppercase text-green-500">LIVE</span>
                            {% else %}
                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                            <span class="text-[10px] uppercase text-yellow-500">{{ post.fields.Status }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Button (Appear on Hover) -->
                    <div class="absolute bottom-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button
                            class="px-4 py-1 text-xs font-mono border border-white/20 rounded hover:bg-white/10 text-white transition-colors">
                            CMD:EDIT
                        </button>
                    </div>

                    <!-- Scanline -->
                    <div
                        class="absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-10 transition-opacity duration-300 bg-gradient-to-b from-transparent via-white/10 to-transparent translate-y-[-100%] group-hover:animate-scanline">
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-span-full py-12 text-center border bordered border-dashed border-white/10 rounded-xl">
                <div class="text-gray-500 font-mono">NO_DATA // INITIATE_CREATION</div>
            </div>
            {% endfor %}
        </div>
    </div>
    </div>
</section>

<!-- Create Post Modal -->
<dialog id="create-post-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Post (Draft)</h3>
            <button class="btn-close" onclick="closeModal('create-post-modal')">×</button>
        </div>
        <form method="POST" action="/admin/blogs/{{ blog.id }}/posts">
            <div class="modal-body">
                <div class="form-group">
                    <label for="title">Post Title / Topic *</label>
                    <input type="text" id="title" name="title" required placeholder="e.g. 5 Ways to Automate Your Blog">
                    <small>This will be the main topic for generation.</small>
                </div>
                <div class="form-group">
                    <label for="voice_id">Voice Override (Optional)</label>
                    <select id="voice_id" name="voice_id">
                        <option value="">-- Use Author Default --</option>
                        {% for v in voices %}
                        <option value="{{ v.id }}">{{ v.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('create-post-modal')">Cancel</button>
                <button type="submit" class="btn primary">Create Draft</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    const modal = document.getElementById('create-post-modal');
    // We target the button via its class
    const openBtn = document.querySelector('.btn.primary');

    if (openBtn) {
        openBtn.addEventListener('click', () => {
            modal.showModal();
        });
    }

    function closeModal(id) {
        document.getElementById(id).close();
    }

    // Close on click outside
    modal.addEventListener('click', (e) => {
        const dialogDimensions = modal.getBoundingClientRect();
        if (
            e.clientX < dialogDimensions.left ||
            e.clientX > dialogDimensions.right ||
            e.clientY < dialogDimensions.top ||
            e.clientY > dialogDimensions.bottom
        ) {
            modal.close();
        }
    });
</script>
{% endblock %}