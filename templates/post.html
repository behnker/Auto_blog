{% extends "base.html" %}

{% block title %}{{ post.fields.MetaTitle or post.fields.Title }} - {{ blog.name }}{% endblock %}

{% block extra_head %}
<!-- Highlight.js for code blocks -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Marked.js for Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<article>
    <div class="article-header">
        <h1 class="article-title">{{ post.fields.Title }}</h1>
        <div class="meta">
            Published on {{ post.fields.PublishedDate[:10] }}
            {% if post.fields.Author_Name %}
            by {{ post.fields.Author_Name }}
            {% endif %}
        </div>
    </div>

    <!-- Container for dynamic content -->
    <div id="content-render" class="article-content"></div>

    <!-- Raw Data (Hidden) -->
    <div id="raw-markdown" style="display: none;">
        {{ post.fields.Content }}
    </div>

    <!-- v2.0 Structured Components -->
    {% if post.fields.TLDR %}
    <div class="article-content" style="margin-top: 2rem;">
        <div
            style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--accent-color);">
            <h3 style="margin-top: 0; color: var(--accent-color);">TL;DR</h3>
            <div id="tldr-render"></div>
        </div>
    </div>
    {% endif %}

    {% if post.fields.FAQ_JSON %}
    <div class="article-content" style="margin-top: 3rem;">
        <h2>Frequently Asked Questions</h2>
        <div id="faq-render"></div>
    </div>
    {% endif %}

</article>

<div style="text-align: center; margin-top: 4rem; display: flex; justify-content: center; gap: 20px;">
    <a href="/blogs/{{ blog.id }}" class="read-more">&larr; Back to {{ blog.name }}</a>
    <a href="/admin/dashboard" class="read-more"
        style="color: var(--accent-color); border-color: var(--accent-color);">Admin Dashboard &rarr;</a>
</div>

<script>
    // Configure Marked
    marked.setOptions({
        highlight: function (code, lang) {
            const language = highlight.getLanguage(lang) ? lang : 'plaintext';
            return highlight.highlight(code, { language }).value;
        },
        breaks: true
    });

    // Render Body
    const rawParams = document.getElementById('raw-markdown').textContent;
    document.getElementById('content-render').innerHTML = marked.parse(rawParams);

    // Render TLDR if v2
    const rawTLDR = `{{ post.fields.TLDR or '' }}`;
    if (rawTLDR) {
        // TLDR is often a JSON list in v2, check if parsable
        try {
            const tldrList = JSON.parse(rawTLDR);
            if (Array.isArray(tldrList)) {
                let html = '<ul>';
                tldrList.forEach(item => html += `<li>${item}</li>`);
                html += '</ul>';
                document.getElementById('tldr-render').innerHTML = html;
            } else {
                document.getElementById('tldr-render').innerText = rawTLDR;
            }
        } catch (e) {
            document.getElementById('tldr-render').innerText = rawTLDR;
        }
    }

    // Render FAQ if v2
    const rawFAQ = `{{ post.fields.FAQ_JSON or '' }}`.replace(/&quot;/g, '"'); // Jinja escape fix
    if (rawFAQ && rawFAQ.length > 5) {
        try {
            const faqList = JSON.parse(rawFAQ);
            let html = '';
            faqList.forEach(item => {
                html += `<div style="margin-bottom: 1.5rem;">`;
                html += `<h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">${item.question}</h3>`;
                html += `<p style="margin-top: 0; color: var(--text-secondary);">${item.answer}</p>`;
                html += `</div>`;
            });
            document.getElementById('faq-render').innerHTML = html;
        } catch (e) {
            console.error("FAQ JSON parse error", e);
        }
    }
</script>
{% endblock %}